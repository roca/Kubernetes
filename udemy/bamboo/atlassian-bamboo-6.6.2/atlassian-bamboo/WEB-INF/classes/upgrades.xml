<!--
This file holds details of all the upgrades for Bamboo

The makeup of this XML file is described here :

<upgrades> The root node of the file. Everything should be contained within this node
    <upgrade> Each upgrade element describes an upgrade task.
        Attributes
        1. build -  This defines the build that the upgrade applies to

        <class> The class element defines the name of the class which performs the upgrade.
        It MUST implement the interface com.atlassian.bamboo.upgrade.UpgradeTask
-->

<upgrades>

  <!--
    Validation tasks are run before bootstrap upgrade tasks. If any of them will report an error application will not run.
    Additional attributes:
    - build-min    when specified disables built-in version logic and makes this task run on existing installations that have build number
                   equal or greater than specified
    - build-max    when specified disables built-in version logic and makes this task run on existing installations that have build number
                   equal or lesser than specified
  -->
  <validation>
    <upgrade build="1" build-min="0" build-max="999999" class="com.atlassian.bamboo.upgrade.tasks.validation.DoNotStartWithHsqldb"/>
    <upgrade build="2" build-min="0" build-max="999999" class="com.atlassian.bamboo.upgrade.tasks.validation.JdbcDriverAvailableInClasspath"/>
    <upgrade build="3" build-min="0" build-max="999999" class="com.atlassian.bamboo.upgrade.tasks.validation.BuildNumberInHomeMatchesDatabase"/>
    <upgrade build="2901" build-min="0" build-max="999999" class="com.atlassian.bamboo.upgrade.tasks.validation.BuildNumberApplicableForUpgrade"/>
    <upgrade build="2902" build-min="0" build-max="999999" class="com.atlassian.bamboo.upgrade.tasks.validation.PlanKeysCorrectlyFormatted"/>
    <upgrade build="4300" build-min="4300" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.ThereIsSingleRowInHibernateUniqueKeyTable"/>
    <upgrade build="4410" build-min="4410" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.BranchKeyStartsWithMastersChainKey"/>
    <upgrade build="51010" build-min="4205" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.IndexDirectoryPresent"/>
    <upgrade build="51012" build-min="0" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.AllMySqlTablesUseInnoDb"/>
    <upgrade build="51102" build-min="51102" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.ServerKeyIsValid"/>
    <upgrade build="51111" build-min="0" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.DatabaseIsSupported"/>
    <upgrade build="51210" build-min="0" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.FileNameEncodingIsReasonable"/>
    <upgrade build="51301" build-min="0" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.MsSqlConfigurationValid"/>
    <upgrade build="51302" build-min="0" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.TableNamesAreCaseInsensitive"/>
    <upgrade build="51404" build-min="0" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.ClearingFelixCache"/>
    <upgrade build="60001" build-min="0" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.MailServerJndiLocationIsValid"/>
    <upgrade build="60601" build-min="0" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.AtlassianUserRepositoriesAreValid"/>
    <upgrade build="60602" build-min="0" build-max="999999"
             class="com.atlassian.bamboo.upgrade.tasks.validation.AtlassianUserDataIsValid"/>

  </validation>

  <bootstrap>
    <!--obsolete upgrade tasks 3601 - 51115 removed -->
    <!-- Version 5.12 (starts with 51200) -->
    <upgrade build="51205" class="com.atlassian.bamboo.upgrade.tasks.v5_12.UpgradeTask51205DropObsoleteCommitFilesColumn"/>
    <upgrade build="51206" class="com.atlassian.bamboo.upgrade.tasks.v5_12.UpgradeTask51206RepairStagesListPosition"/>
    <upgrade build="51207" class="com.atlassian.bamboo.upgrade.tasks.v5_12.UpgradeTask51207RepairStagesResultsListPosition"/>

    <!-- Version 5.13 (starts with 51300) -->
    <upgrade build="51301" class="com.atlassian.bamboo.upgrade.tasks.v5_13.UpgradeTask51301UpperCaseDbColumnNames"/>
    <upgrade build="51303" class="com.atlassian.bamboo.upgrade.tasks.v5_13.UpgradeTask51303UpdateHibernateDialectUpgradeTask"/>
    <upgrade build="51304" class="com.atlassian.bamboo.upgrade.tasks.v5_13.UpgradeTask51304UpdateHibernateDialectUpgradeTask"/>
    <upgrade build="51306" class="com.atlassian.bamboo.upgrade.tasks.v5_13.UpgradeTask51306UpdateSerializationSecurityConfig"/>

    <!-- Version 5.14 (starts with 51400) -->
    <upgrade build="51401" class="com.atlassian.bamboo.upgrade.tasks.v5_14.UpgradeTask51401UpperCaseDbTableNames"/>

    <!-- Version 5.15 (starts with 51500) -->
    <upgrade build="51502" class="com.atlassian.bamboo.upgrade.tasks.v5_15.UpgradeTask51502UniqueSharedCredentialNames"/>
    <upgrade build="51503" class="com.atlassian.bamboo.upgrade.tasks.v5_15.UpgradeTask51503ConvertVariableValueToLargeText"/>
    <upgrade build="51507" class="com.atlassian.bamboo.upgrade.tasks.v5_15.UpgradeTask51507ResizeChangesetColumns"/>
    <upgrade build="51509" class="com.atlassian.bamboo.upgrade.tasks.v5_15.UpgradeTask51509DropHibernate2FkConstraints"/>
    <upgrade build="51510" class="com.atlassian.bamboo.upgrade.tasks.v5_15.UpgradeTask51510RemoveDetachedArtifactLinks"/>
    <upgrade build="51511" class="com.atlassian.bamboo.upgrade.tasks.v5_15.UpgradeTask51511ConvertNumericColumnsToBigints"/>
    <upgrade build="51512" class="com.atlassian.bamboo.upgrade.tasks.v5_15.UpgradeTask51512DropDeploymentVariableSubstitutionTable"/>

    <!-- Version 5.16 (starts with 51600) -->
    <upgrade build="51601" class="com.atlassian.bamboo.upgrade.tasks.v5_16.UpgradeTask51601DropIndexInVariableBaselineItem"/>
    <upgrade build="51604" class="com.atlassian.bamboo.upgrade.tasks.v5_16.UpgradeTask51604RemoveExplicitIndexOnUniqueColumns"/>
    <upgrade build="51605" class="com.atlassian.bamboo.upgrade.tasks.v5_16.UpgradeTask51605RemoveOldForeignKeysFromRenamedTables"/>

    <!-- Version 6.2 (starts with 60200) -->
    <upgrade build="60205" class="com.atlassian.bamboo.upgrade.tasks.v6_2.UpgradeTask60205SetRepositoryLogsPath"/>

    <!-- Version 6.3 (starts with 60300) -->
    <upgrade build="60304" class="com.atlassian.bamboo.upgrade.tasks.v6_3.UpgradeTask60304SetDefaultDockerImageForRss"/>

    <!-- Version 6.4 (starts with 60400) -->
    <upgrade build="60402" class="com.atlassian.bamboo.upgrade.tasks.v6_4.UpgradeTask60402PrepareForAddingDeletionCascades"/>
    <upgrade build="60403" class="com.atlassian.bamboo.upgrade.tasks.v6_4.UpgradeTask60403InitRssSecuritySettings"/>

    <!-- Version 6.5 (starts with 60500) -->
    <upgrade build="60501" class="com.atlassian.bamboo.upgrade.tasks.v6_5.UpgradeTask60501PrepareForAddingDeletionCascades"/>
    <upgrade build="60502" class="com.atlassian.bamboo.upgrade.tasks.v6_5.UpgradeTask60502PrepareForAddingDeletionCascades"/>
    <upgrade build="60503" class="com.atlassian.bamboo.upgrade.tasks.v6_5.UpgradeTask60503PrepareForAddingDeletionCascades"/>
    <upgrade build="60504" class="com.atlassian.bamboo.upgrade.tasks.v6_5.UpgradeTask60504DropObsoleteBrsColumn"/>
    <upgrade build="60505" class="com.atlassian.bamboo.upgrade.tasks.v6_5.UpgradeTask60505RenameUniqueIndexOnNotificationsTable"/>
    <upgrade build="60507" class="com.atlassian.bamboo.upgrade.tasks.v6_5.UpgradeTask60507DropKeyNumberIndexOnBrs"/>
    <upgrade build="60508" class="com.atlassian.bamboo.upgrade.tasks.v6_5.UpgradeTask60508RemoveUnusedPropertyFromConfig"/>
    <upgrade build="60509" class="com.atlassian.bamboo.upgrade.tasks.v6_5.UpgradeTask60509ChangeStartedDateColumnTypeMSSQL"/>
  </bootstrap>

  <postBootstrap>
    <!--obsolete upgrade tasks 3601 - 51115 removed -->

    <!-- Version 5.12 (starts with 51200) -->
    <upgrade build="51201" class="com.atlassian.bamboo.upgrade.tasks.v5_12.UpgradeTask51201InitializeChainStorageTag"/>
    <upgrade build="51208" class="com.atlassian.bamboo.upgrade.tasks.v5_12.UpgradeTask51208FixS3ArtifactHandlerForServer"/>

    <!-- Version 5.13 (starts with 51300) -->
    <upgrade build="51305" class="com.atlassian.bamboo.upgrade.tasks.v5_13.UpgradeTask51305RefactorGitRepositoriesConfiguration"/>
    <upgrade build="51308" class="com.atlassian.bamboo.upgrade.tasks.v5_13.UpgradeTask51308RefactorHgRepositoriesConfiguration"/>
    <upgrade build="51310" class="com.atlassian.bamboo.upgrade.tasks.v5_13.UpgradeTask51310DropIdePortFromUserProperties"/>
    <upgrade build="51311" class="com.atlassian.bamboo.upgrade.tasks.v5_13.UpgradeTask51311RefactorBitbucketRepositoriesConfiguration"/>
    <upgrade build="51313" class="com.atlassian.bamboo.upgrade.tasks.v5_13.UpgradeTask51313MigrateLegacyScriptTasks"/>
    <upgrade build="51314" class="com.atlassian.bamboo.upgrade.tasks.v5_13.UpgradeTask51314ConvertPathsInDownloadTasks"/>
    <upgrade build="51315" class="com.atlassian.bamboo.upgrade.tasks.v5_13.UpgradeTask51315ConvertPathsInArtifactDefinitions"/>

    <!-- Version 5.14 (starts with 51400) -->
    <upgrade build="51402" class="com.atlassian.bamboo.upgrade.tasks.v5_14.UpgradeTask51402ReseedServerKeyAndOids"/>
    <upgrade build="51403" class="com.atlassian.bamboo.upgrade.tasks.v5_14.UpgradeTask51403FixDeploymentTasksOids"/>
    <upgrade build="51405" class="com.atlassian.bamboo.upgrade.tasks.v5_14.UpgradeTask51405SetParentInRepositories"/>
    <upgrade build="51406" class="com.atlassian.bamboo.upgrade.tasks.v5_14.UpgradeTask51406UseNewXmlFormatForRepositories"/>
    <upgrade build="51407" class="com.atlassian.bamboo.upgrade.tasks.v5_14.UpgradeTask51407ConvertRepositoryTypes"/>
    <upgrade build="51408" class="com.atlassian.bamboo.upgrade.tasks.v5_14.UpgradeTask51408MoveSvnBranchDetectionConfigurationToVcsData"/>
    <upgrade build="51415" class="com.atlassian.bamboo.upgrade.tasks.v5_14.UpgradeTask51415FixStashSshKeys"/>
    <upgrade build="51416" class="com.atlassian.bamboo.upgrade.tasks.v5_14.UpgradeTask51416FixSvnVcsBranch"/>

    <!-- Version 5.15 (starts with 51500) -->
    <upgrade build="51504" class="com.atlassian.bamboo.upgrade.tasks.v5_15.UpgradeTask51504EncryptVariableDefinition"/>
    <upgrade build="51505" class="com.atlassian.bamboo.upgrade.tasks.v5_15.UpgradeTask51505EncryptRepositoryDefinition"/>
    <upgrade build="51506" class="com.atlassian.bamboo.upgrade.tasks.v5_15.UpgradeTask51506ReEncryptSharedCredentials"/>
    <upgrade build="51518" class="com.atlassian.bamboo.upgrade.tasks.v5_15.UpgradeTask51518ReEncryptPlanBranchRepositories"/>

    <!-- Version 5.16 (starts with 51600) -->
    <upgrade build="51602" class="com.atlassian.bamboo.upgrade.tasks.v5_16.UpgradeTask51602ReEncryptMailPassword"/>

    <!-- Version 6.1 (starts with 60100) -->
    <upgrade build="60101" class="com.atlassian.bamboo.upgrade.tasks.v6_1.UpgradeTask60101AddUniqueIndex"/>
    <upgrade build="60103" class="com.atlassian.bamboo.upgrade.tasks.v6_1.UpgradeTask60103UpdatePlanBranchMonitoringSettings"/>

    <!-- Version 6.2 (starts with 60200) -->
    <upgrade build="60201" class="com.atlassian.bamboo.upgrade.tasks.v6_2.UpgradeTask60201CreateProjectAcls"/>
    <upgrade build="60203" class="com.atlassian.bamboo.upgrade.tasks.v6_2.UpgradeTask60203DropExplicitForeignKeyIndices"/>
    <upgrade build="60208" class="com.atlassian.bamboo.upgrade.tasks.v6_2.UpgradeTask60208PartialReindexForQuickSearchProjects"/>

    <!-- Version 6.3 (starts with 60300) -->
    <upgrade build="60301" class="com.atlassian.bamboo.upgrade.tasks.v6_3.UpgradeTask60301GrantMissingPermissions"/>
    <upgrade build="60303" class="com.atlassian.bamboo.upgrade.tasks.v6_3.UpgradeTask60303AddSpecsSource"/>

    <upgrade build="60601" class="com.atlassian.bamboo.upgrade.tasks.v6_6.UpgradeTask60601MigrateAtlassianUserConfiguration"/>
    <upgrade build="60602" class="com.atlassian.bamboo.upgrade.tasks.v6_6.UpgradeTask60602MoveUsersToEmbeddedCrowd"/>

  </postBootstrap>

  <!-- repeatable upgrade tasks are run _after_ regular upgrade task if build number is within the range -->
  <repeatable>
    <upgrade build="51203" build-min="0" build-max="999999" class="com.atlassian.bamboo.migration.cloud.upgrade.ConvertRestrictedAdmins"/>
    <upgrade build="51204" build-min="0" build-max="999999" class="com.atlassian.bamboo.migration.cloud.upgrade.EnableServerPlugins"/>
    <upgrade build="51209" build-min="0" build-max="999999" class="com.atlassian.bamboo.migration.cloud.upgrade.ResetServerCapabilities"/>

    <upgrade build="51409" build-min="51408" build-max="999999" class="com.atlassian.bamboo.upgrade.tasks.repeatable.ConvertRepositoryTypes"/>

    <upgrade build="51508" build-min="0" build-max="999999" class="com.atlassian.bamboo.upgrade.tasks.repeatable.ApplySchemaFixups"/>

    <upgrade build="60204" build-min="0" build-max="999999" class="com.atlassian.bamboo.upgrade.tasks.repeatable.AddIndicesToForeignKeys"/>
    <upgrade build="60401" build-min="0" build-max="999999" class="com.atlassian.bamboo.upgrade.tasks.repeatable.UpdateSpecsRunnerDockerImage"/>
  </repeatable>

</upgrades>
